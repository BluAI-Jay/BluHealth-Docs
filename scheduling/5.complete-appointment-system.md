# Medical Appointment Scheduling System - Complete Documentation

## Table of Contents
1. [System Overview](#system-overview)
2. [Conceptual Design](#conceptual-design)
3. [Database Schema](#database-schema)
4. [API Architecture](#api-architecture)
5. [Sequence Diagrams](#sequence-diagrams)
6. [Backend Implementation (Node.js)](#backend-implementation)
7. [Frontend Implementation (Next.js)](#frontend-implementation)
8. [HTML Reference UI](#html-reference-ui)
9. [Deployment Instructions](#deployment-instructions)

---

## System Overview

A comprehensive patient-physician appointment scheduling system that allows:

- **Patients**: Book, reschedule, and cancel appointments; view schedules; manage copayments
- **Physicians**: Manage schedules, view appointments, access patient records, set time-off
- **Staff**: Manage all appointments, process payments, view clinic statistics

### Key Features

- Real-time appointment scheduling with conflict prevention
- Multi-location support for physicians
- Integrated copayment tracking
- EHR system integration
- Role-based access control
- Responsive web interface

---

## Conceptual Design

### System Components

1. **User Management**
   - Patients: Can book, cancel, reschedule appointments
   - Physicians: Manage schedules, view appointments, access patient records
   - Office Staff: Manage appointments on behalf of patients, handle copays

2. **Schedule Management**
   - Physician availability (working days, hours, breaks)
   - Office/location management
   - Vacation and time-off tracking
   - Recurring schedule patterns

3. **Appointment Management**
   - Booking system with available time slots
   - Cancellation and rescheduling
   - Follow-up appointment scheduling
   - Appointment status tracking

4. **Financial Management**
   - Insurance copay tracking
   - Amount due calculation
   - Payment status monitoring

5. **Integration**
   - Patient record system integration
   - Real-time availability updates
   - Notification system

---

## Database Schema

```sql
-- Users table (base for all user types)
CREATE TABLE users (
    id SERIAL PRIMARY KEY,
    email VARCHAR(255) UNIQUE NOT NULL,
    password_hash VARCHAR(255) NOT NULL,
    role VARCHAR(50) NOT NULL, -- 'patient', 'physician', 'staff'
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- Patients
CREATE TABLE patients (
    id SERIAL PRIMARY KEY,
    user_id INTEGER REFERENCES users(id),
    first_name VARCHAR(100) NOT NULL,
    last_name VARCHAR(100) NOT NULL,
    date_of_birth DATE,
    phone VARCHAR(20),
    address TEXT,
    insurance_provider VARCHAR(100),
    insurance_id VARCHAR(50)
);

-- Physicians
CREATE TABLE physicians (
    id SERIAL PRIMARY KEY,
    user_id INTEGER REFERENCES users(id),
    first_name VARCHAR(100) NOT NULL,
    last_name VARCHAR(100) NOT NULL,
    specialization VARCHAR(100),
    license_number VARCHAR(50)
);

-- Office Staff
CREATE TABLE staff (
    id SERIAL PRIMARY KEY,
    user_id INTEGER REFERENCES users(id),
    first_name VARCHAR(100) NOT NULL,
    last_name VARCHAR(100) NOT NULL,
    department VARCHAR(100)
);

-- Locations
CREATE TABLE locations (
    id SERIAL PRIMARY KEY,
    name VARCHAR(100) NOT NULL,
    address TEXT,
    phone VARCHAR(20)
);

-- Physician Schedules
CREATE TABLE physician_schedules (
    id SERIAL PRIMARY KEY,
    physician_id INTEGER REFERENCES physicians(id),
    location_id INTEGER REFERENCES locations(id),
    day_of_week INTEGER, -- 0-6 (Sunday-Saturday)
    start_time TIME,
    end_time TIME,
    lunch_start TIME,
    lunch_end TIME,
    is_active BOOLEAN DEFAULT true
);

-- Time Off
CREATE TABLE physician_time_off (
    id SERIAL PRIMARY KEY,
    physician_id INTEGER REFERENCES physicians(id),
    start_date DATE,
    end_date DATE,
    reason VARCHAR(100)
);

-- Appointments
CREATE TABLE appointments (
    id SERIAL PRIMARY KEY,
    patient_id INTEGER REFERENCES patients(id),
    physician_id INTEGER REFERENCES physicians(id),
    location_id INTEGER REFERENCES locations(id),
    appointment_date DATE,
    start_time TIME,
    end_time TIME,
    status VARCHAR(50) DEFAULT 'scheduled', -- 'scheduled', 'completed', 'cancelled', 'no-show'
    reason_for_visit TEXT,
    notes TEXT,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- Financial Records
CREATE TABLE appointment_financials (
    id SERIAL PRIMARY KEY,
    appointment_id INTEGER REFERENCES appointments(id),
    total_charge DECIMAL(10, 2),
    insurance_coverage DECIMAL(10, 2),
    copay_amount DECIMAL(10, 2),
    amount_due DECIMAL(10, 2),
    payment_status VARCHAR(50) DEFAULT 'pending', -- 'pending', 'partial', 'paid'
    payment_date DATE
);
```

---

## API Architecture

### Authentication & Authorization
- JWT-based authentication
- Role-based access control (RBAC)
- Secure password hashing with bcrypt

### Core API Endpoints

1. **Authentication**
   - POST `/api/auth/login`
   - POST `/api/auth/register`
   - POST `/api/auth/logout`
   - GET `/api/auth/me`

2. **Schedule Management**
   - GET `/api/physicians/:id/schedule`
   - POST `/api/physicians/:id/schedule`
   - PUT `/api/physicians/:id/schedule/:scheduleId`
   - DELETE `/api/physicians/:id/schedule/:scheduleId`
   - POST `/api/physicians/:id/time-off`
   - GET `/api/physicians/:id/available-slots`

3. **Appointment Management**
   - GET `/api/appointments`
   - GET `/api/appointments/:id`
   - POST `/api/appointments`
   - PUT `/api/appointments/:id`
   - DELETE `/api/appointments/:id`
   - POST `/api/appointments/:id/reschedule`

4. **Patient Management**
   - GET `/api/patients/:id`
   - PUT `/api/patients/:id`
   - GET `/api/patients/:id/appointments`

5. **Financial Management**
   - GET `/api/appointments/:id/financials`
   - PUT `/api/appointments/:id/financials`
   - POST `/api/appointments/:id/payment`

### Security Considerations

1. **Authentication**: Multi-factor authentication support
2. **Data Encryption**: Encrypt sensitive patient data at rest
3. **HIPAA Compliance**: Audit logs for all data access
4. **Session Management**: Secure session handling with timeouts
5. **Input Validation**: Comprehensive input sanitization

---

## Sequence Diagrams

### Appointment Booking Flow

```mermaid
sequenceDiagram
    participant P as Patient
    participant UI as Web Interface
    participant API as API Server
    participant DB as Database
    participant EHR as EHR System
    participant NS as Notification Service

    rect rgb(230, 240, 250)
        Note over P,NS: Appointment Booking Flow
        P->>UI: Access scheduling system
        UI->>API: Request available physicians
        API->>DB: Query physicians by specialty/location
        DB-->>API: Return physician list
        API-->>UI: Send physician data
        UI-->>P: Display physicians
        
        P->>UI: Select physician and date
        UI->>API: Request available time slots
        API->>DB: Check physician schedule
        API->>DB: Check existing appointments
        API->>DB: Check time-off periods
        DB-->>API: Return availability data
        API-->>UI: Send available slots
        UI-->>P: Display time slots
        
        P->>UI: Select time slot & enter details
        UI->>API: Create appointment request
        API->>DB: Validate slot availability
        API->>DB: Create appointment record
        API->>DB: Create financial record
        DB-->>API: Confirm creation
        API->>NS: Send confirmation email/SMS
        API-->>UI: Return confirmation
        UI-->>P: Show confirmation
    end
```

### Physician Schedule Management

```mermaid
sequenceDiagram
    participant P as Physician
    participant UI as Web Interface
    participant API as API Server
    participant DB as Database
    participant NS as Notification Service

    rect rgb(250, 230, 240)
        Note over P,NS: Physician Schedule Management
        P->>UI: Access schedule management
        UI->>API: Get current schedule
        API->>DB: Query physician schedules
        DB-->>API: Return schedule data
        API-->>UI: Send schedule
        UI-->>P: Display schedule
        
        P->>UI: Update schedule/Add time-off
        UI->>API: Update schedule request
        API->>DB: Update schedule records
        API->>DB: Check affected appointments
        DB-->>API: Return affected appointments
        API->>NS: Notify affected patients
        API-->>UI: Confirm update
    end
```

### Appointment Rescheduling

```mermaid
sequenceDiagram
    participant P as Patient
    participant UI as Web Interface
    participant API as API Server
    participant DB as Database
    participant NS as Notification Service

    rect rgb(240, 250, 230)
        Note over P,NS: Appointment Rescheduling
        P->>UI: Request reschedule
        UI->>API: Get appointment details
        API->>DB: Fetch appointment
        DB-->>API: Return appointment
        API-->>UI: Send appointment data
        
        P->>UI: Select new time slot
        UI->>API: Check new slot availability
        API->>DB: Validate availability
        DB-->>API: Confirm availability
        API->>DB: Update appointment
        DB-->>API: Confirm update
        API->>NS: Send reschedule notification
        API-->>UI: Confirm reschedule
        UI-->>P: Show confirmation
    end
```

### Physician Daily View

```mermaid
sequenceDiagram
    participant P as Physician
    participant UI as Web Interface
    participant API as API Server
    participant DB as Database
    participant EHR as EHR System

    rect rgb(250, 240, 230)
        Note over P,EHR: Physician Daily View
        P->>UI: Access daily schedule
        UI->>API: Get today's appointments
        API->>DB: Query appointments
        DB-->>API: Return appointments
        API-->>UI: Send appointment list
        UI-->>P: Display schedule
        
        P->>UI: Click on patient
        UI->>API: Request patient access
        API->>EHR: Request patient record
        EHR-->>API: Return patient data/URL
        API-->>UI: Send EHR access
        UI->>EHR: Launch patient record
    end
```

### Copay Management

```mermaid
sequenceDiagram
    participant P as Patient/Staff
    participant UI as Web Interface
    participant API as API Server
    participant DB as Database
    participant NS as Notification Service

    rect rgb(240, 230, 250)
        Note over P,NS: Copay Management
        P->>UI: View appointment financials
        UI->>API: Get financial details
        API->>DB: Query financial records
        DB-->>API: Return copay info
        API-->>UI: Send financial data
        UI-->>P: Display amount due
        
        P->>UI: Process payment
        UI->>API: Submit payment
        API->>DB: Update payment status
        DB-->>API: Confirm update
        API->>NS: Send payment receipt
        API-->>UI: Confirm payment
        UI-->>P: Show receipt
    end
```

---

## Backend Implementation

### Package Configuration (package.json)

```json
{
  "name": "appointment-scheduler-backend",
  "version": "1.0.0",
  "scripts": {
    "dev": "nodemon server.js",
    "start": "node server.js"
  },
  "dependencies": {
    "express": "^4.18.2",
    "pg": "^8.11.3",
    "bcryptjs": "^2.4.3",
    "jsonwebtoken": "^9.0.2",
    "cors": "^2.8.5",
    "dotenv": "^16.3.1",
    "express-validator": "^7.0.1",
    "moment": "^2.29.4"
  },
  "devDependencies": {
    "nodemon": "^3.0.1"
  }
}
```

### Environment Configuration (.env)

```env
DATABASE_URL=postgresql://username:password@localhost:5432/appointment_scheduler
JWT_SECRET=your-secret-key-here
PORT=5000
```

### Main Server (server.js)

```javascript
require('dotenv').config();
const express = require('express');
const cors = require('cors');
const authRoutes = require('./routes/auth');
const appointmentRoutes = require('./routes/appointments');
const physicianRoutes = require('./routes/physicians');
const patientRoutes = require('./routes/patients');
const financialRoutes = require('./routes/financials');

const app = express();

app.use(cors());
app.use(express.json());

// Routes
app.use('/api/auth', authRoutes);
app.use('/api/appointments', appointmentRoutes);
app.use('/api/physicians', physicianRoutes);
app.use('/api/patients', patientRoutes);
app.use('/api/financials', financialRoutes);

const PORT = process.env.PORT || 5000;
app.listen(PORT, () => {
  console.log(`Server running on port ${PORT}`);
});
```

### Database Configuration (config/db.js)

```javascript
const { Pool } = require('pg');

const pool = new Pool({
  connectionString: process.env.DATABASE_URL,
});

module.exports = {
  query: (text, params) => pool.query(text, params),
};
```

### Authentication Middleware (middleware/auth.js)

```javascript
const jwt = require('jsonwebtoken');

module.exports = (req, res, next) => {
  const token = req.header('Authorization')?.replace('Bearer ', '');

  if (!token) {
    return res.status(401).json({ error: 'Access denied' });
  }

  try {
    const verified = jwt.verify(token, process.env.JWT_SECRET);
    req.user = verified;
    next();
  } catch (error) {
    res.status(401).json({ error: 'Invalid token' });
  }
};
```

### Authentication Routes (routes/auth.js)

```javascript
const express = require('express');
const bcrypt = require('bcryptjs');
const jwt = require('jsonwebtoken');
const { body, validationResult } = require('express-validator');
const db = require('../config/db');

const router = express.Router();

// Register
router.post('/register', [
  body('email').isEmail(),
  body('password').isLength({ min: 6 }),
  body('role').isIn(['patient', 'physician', 'staff']),
  body('firstName').notEmpty(),
  body('lastName').notEmpty()
], async (req, res) => {
  const errors = validationResult(req);
  if (!errors.isEmpty()) {
    return res.status(400).json({ errors: errors.array() });
  }

  const { email, password, role, firstName, lastName, ...additionalData } = req.body;

  try {
    // Check if user exists
    const userExists = await db.query('SELECT * FROM users WHERE email = $1', [email]);
    if (userExists.rows.length > 0) {
      return res.status(400).json({ error: 'User already exists' });
    }

    // Hash password
    const hashedPassword = await bcrypt.hash(password, 10);

    // Create user
    const newUser = await db.query(
      'INSERT INTO users (email, password_hash, role) VALUES ($1, $2, $3) RETURNING id',
      [email, hashedPassword, role]
    );

    const userId = newUser.rows[0].id;

    // Create role-specific record
    if (role === 'patient') {
      await db.query(
        'INSERT INTO patients (user_id, first_name, last_name, phone, insurance_provider, insurance_id) VALUES ($1, $2, $3, $4, $5, $6)',
        [userId, firstName, lastName, additionalData.phone, additionalData.insuranceProvider, additionalData.insuranceId]
      );
    } else if (role === 'physician') {
      await db.query(
        'INSERT INTO physicians (user_id, first_name, last_name, specialization, license_number) VALUES ($1, $2, $3, $4, $5)',
        [userId, firstName, lastName, additionalData.specialization, additionalData.licenseNumber]
      );
    } else if (role === 'staff') {
      await db.query(
        'INSERT INTO staff (user_id, first_name, last_name, department) VALUES ($1, $2, $3, $4)',
        [userId, firstName, lastName, additionalData.department]
      );
    }

    res.status(201).json({ message: 'User created successfully' });
  } catch (error) {
    console.error(error);
    res.status(500).json({ error: 'Server error' });
  }
});

// Login
router.post('/login', [
  body('email').isEmail(),
  body('password').exists()
], async (req, res) => {
  const errors = validationResult(req);
  if (!errors.isEmpty()) {
    return res.status(400).json({ errors: errors.array() });
  }

  const { email, password } = req.body;

  try {
    // Get user
    const user = await db.query('SELECT * FROM users WHERE email = $1', [email]);
    if (user.rows.length === 0) {
      return res.status(401).json({ error: 'Invalid credentials' });
    }

    // Check password
    const validPassword = await bcrypt.compare(password, user.rows[0].password_hash);
    if (!validPassword) {
      return res.status(401).json({ error: 'Invalid credentials' });
    }

    // Get user details based on role
    let userDetails;
    if (user.rows[0].role === 'patient') {
      userDetails = await db.query('SELECT * FROM patients WHERE user_id = $1', [user.rows[0].id]);
    } else if (user.rows[0].role === 'physician') {
      userDetails = await db.query('SELECT * FROM physicians WHERE user_id = $1', [user.rows[0].id]);
    } else if (user.rows[0].role === 'staff') {
      userDetails = await db.query('SELECT * FROM staff WHERE user_id = $1', [user.rows[0].id]);
    }

    // Create token
    const token = jwt.sign(
      { 
        id: user.rows[0].id, 
        email: user.rows[0].email, 
        role: user.rows[0].role,
        roleId: userDetails.rows[0].id
      },
      process.env.JWT_SECRET,
      { expiresIn: '24h' }
    );

    res.json({
      token,
      user: {
        id: user.rows[0].id,
        email: user.rows[0].email,
        role: user.rows[0].role,
        ...userDetails.rows[0]
      }
    });
  } catch (error) {
    console.error(error);
    res.status(500).json({ error: 'Server error' });
  }
});

module.exports = router;
```

### Physician Routes (routes/physicians.js)

```javascript
const express = require('express');
const auth = require('../middleware/auth');
const db = require('../config/db');
const moment = require('moment');

const router = express.Router();

// Get physician schedule
router.get('/:id/schedule', auth, async (req, res) => {
  try {
    const schedule = await db.query(
      `SELECT ps.*, l.name as location_name 
       FROM physician_schedules ps
       JOIN locations l ON ps.location_id = l.id
       WHERE ps.physician_id = $1 AND ps.is_active = true
       ORDER BY ps.day_of_week`,
      [req.params.id]
    );

    res.json(schedule.rows);
  } catch (error) {
    console.error(error);
    res.status(500).json({ error: 'Server error' });
  }
});

// Create/Update physician schedule
router.post('/:id/schedule', auth, async (req, res) => {
  const { locationId, dayOfWeek, startTime, endTime, lunchStart, lunchEnd } = req.body;

  try {
    // Check if schedule exists
    const existing = await db.query(
      'SELECT * FROM physician_schedules WHERE physician_id = $1 AND day_of_week = $2 AND location_id = $3',
      [req.params.id, dayOfWeek, locationId]
    );

    if (existing.rows.length > 0) {
      // Update
      await db.query(
        `UPDATE physician_schedules 
         SET start_time = $1, end_time = $2, lunch_start = $3, lunch_end = $4, is_active = true
         WHERE id = $5`,
        [startTime, endTime, lunchStart, lunchEnd, existing.rows[0].id]
      );
    } else {
      // Create
      await db.query(
        `INSERT INTO physician_schedules (physician_id, location_id, day_of_week, start_time, end_time, lunch_start, lunch_end)
         VALUES ($1, $2, $3, $4, $5, $6, $7)`,
        [req.params.id, locationId, dayOfWeek, startTime, endTime, lunchStart, lunchEnd]
      );
    }

    res.json({ message: 'Schedule updated successfully' });
  } catch (error) {
    console.error(error);
    res.status(500).json({ error: 'Server error' });
  }
});

// Add time off
router.post('/:id/time-off', auth, async (req, res) => {
  const { startDate, endDate, reason } = req.body;

  try {
    await db.query(
      'INSERT INTO physician_time_off (physician_id, start_date, end_date, reason) VALUES ($1, $2, $3, $4)',
      [req.params.id, startDate, endDate, reason]
    );

    // TODO: Notify affected patients

    res.json({ message: 'Time off added successfully' });
  } catch (error) {
    console.error(error);
    res.status(500).json({ error: 'Server error' });
  }
});

// Get available time slots
router.get('/:id/available-slots', async (req, res) => {
  const { date, duration = 30 } = req.query;
  const requestedDate = moment(date);
  const dayOfWeek = requestedDate.day();

  try {
    // Get physician schedule for that day
    const schedule = await db.query(
      `SELECT * FROM physician_schedules 
       WHERE physician_id = $1 AND day_of_week = $2 AND is_active = true`,
      [req.params.id, dayOfWeek]
    );

    if (schedule.rows.length === 0) {
      return res.json({ slots: [] });
    }

    const { start_time, end_time, lunch_start, lunch_end } = schedule.rows[0];

    // Check if physician is off that day
    const timeOff = await db.query(
      'SELECT * FROM physician_time_off WHERE physician_id = $1 AND $2::date BETWEEN start_date AND end_date',
      [req.params.id, date]
    );

    if (timeOff.rows.length > 0) {
      return res.json({ slots: [] });
    }

    // Get existing appointments
    const appointments = await db.query(
      'SELECT start_time, end_time FROM appointments WHERE physician_id = $1 AND appointment_date = $2 AND status != $3',
      [req.params.id, date, 'cancelled']
    );

    // Generate available slots
    const slots = [];
    let currentTime = moment(`${date} ${start_time}`, 'YYYY-MM-DD HH:mm:ss');
    const endMoment = moment(`${date} ${end_time}`, 'YYYY-MM-DD HH:mm:ss');
    const lunchStartMoment = moment(`${date} ${lunch_start}`, 'YYYY-MM-DD HH:mm:ss');
    const lunchEndMoment = moment(`${date} ${lunch_end}`, 'YYYY-MM-DD HH:mm:ss');

    while (currentTime.isBefore(endMoment)) {
      const slotEnd = currentTime.clone().add(duration, 'minutes');

      // Check if slot overlaps with lunch
      if (currentTime.isSameOrAfter(lunchStartMoment) && currentTime.isBefore(lunchEndMoment)) {
        currentTime = lunchEndMoment.clone();
        continue;
      }

      // Check if slot overlaps with existing appointments
      const isBooked = appointments.rows.some(apt => {
        const aptStart = moment(`${date} ${apt.start_time}`, 'YYYY-MM-DD HH:mm:ss');
        const aptEnd = moment(`${date} ${apt.end_time}`, 'YYYY-MM-DD HH:mm:ss');
        return currentTime.isBefore(aptEnd) && slotEnd.isAfter(aptStart);
      });

      if (!isBooked) {
        slots.push({
          start: currentTime.format('HH:mm'),
          end: slotEnd.format('HH:mm')
        });
      }

      currentTime.add(duration, 'minutes');
    }

    res.json({ slots });
  } catch (error) {
    console.error(error);
    res.status(500).json({ error: 'Server error' });
  }
});

// Get all physicians
router.get('/', async (req, res) => {
  const { specialization, locationId } = req.query;

  try {
    let query = `
      SELECT DISTINCT p.*, u.email 
      FROM physicians p
      JOIN users u ON p.user_id = u.id
    `;
    
    const params = [];
    const conditions = [];

    if (specialization) {
      conditions.push(`p.specialization = $${params.length + 1}`);
      params.push(specialization);
    }

    if (locationId) {
      query += ' JOIN physician_schedules ps ON p.id = ps.physician_id';
      conditions.push(`ps.location_id = $${params.length + 1} AND ps.is_active = true`);
      params.push(locationId);
    }

    if (conditions.length > 0) {
      query += ' WHERE ' + conditions.join(' AND ');
    }

    const physicians = await db.query(query, params);
    res.json(physicians.rows);
  } catch (error) {
    console.error(error);
    res.status(500).json({ error: 'Server error' });
  }
});

module.exports = router;
```

### Appointment Routes (routes/appointments.js)

```javascript
const express = require('express');
const auth = require('../middleware/auth');
const db = require('../config/db');

const router = express.Router();

// Get appointments
router.get('/', auth, async (req, res) => {
  const { date, physicianId, patientId, status } = req.query;

  try {
    let query = `
      SELECT a.*, 
             p.first_name as patient_first_name, p.last_name as patient_last_name,
             ph.first_name as physician_first_name, ph.last_name as physician_last_name,
             l.name as location_name,
             af.copay_amount, af.amount_due, af.payment_status
      FROM appointments a
      JOIN patients p ON a.patient_id = p.id
      JOIN physicians ph ON a.physician_id = ph.id
      JOIN locations l ON a.location_id = l.id
      LEFT JOIN appointment_financials af ON a.id = af.appointment_id
      WHERE 1=1
    `;

    const params = [];

    if (date) {
      query += ` AND a.appointment_date = $${params.length + 1}`;
      params.push(date);
    }

    if (physicianId) {
      query += ` AND a.physician_id = $${params.length + 1}`;
      params.push(physicianId);
    }

    if (patientId) {
      query += ` AND a.patient_id = $${params.length + 1}`;
      params.push(patientId);
    }

    if (status) {
      query += ` AND a.status = $${params.length + 1}`;
      params.push(status);
    }

    // Role-based filtering
    if (req.user.role === 'patient') {
      query += ` AND a.patient_id = $${params.length + 1}`;
      params.push(req.user.roleId);
    } else if (req.user.role === 'physician') {
      query += ` AND a.physician_id = $${params.length + 1}`;
      params.push(req.user.roleId);
    }

    query += ' ORDER BY a.appointment_date, a.start_time';

    const appointments = await db.query(query, params);
    res.json(appointments.rows);
  } catch (error) {
    console.error(error);
    res.status(500).json({ error: 'Server error' });
  }
});

// Create appointment
router.post('/', auth, async (req, res) => {
  const { 
    patientId, 
    physicianId, 
    locationId, 
    appointmentDate, 
    startTime, 
    endTime, 
    reasonForVisit,
    copayAmount 
  } = req.body;

  try {
    // Validate slot availability
    const existing = await db.query(
      `SELECT * FROM appointments 
       WHERE physician_id = $1 AND appointment_date = $2 
       AND status != 'cancelled'
       AND ((start_time <= $3 AND end_time > $3) OR (start_time < $4 AND end_time >= $4))`,
      [physicianId, appointmentDate, startTime, endTime]
    );

    if (existing.rows.length > 0) {
      return res.status(400).json({ error: 'Time slot not available' });
    }

    // Create appointment
    const appointment = await db.query(
      `INSERT INTO appointments (patient_id, physician_id, location_id, appointment_date, start_time, end_time, reason_for_visit)
       VALUES ($1, $2, $3, $4, $5, $6, $7) RETURNING id`,
      [patientId || req.user.roleId, physicianId, locationId, appointmentDate, startTime, endTime, reasonForVisit]
    );

    const appointmentId = appointment.rows[0].id;

    // Create financial record
    await db.query(
      `INSERT INTO appointment_financials (appointment_id, copay_amount, amount_due, payment_status)
       VALUES ($1, $2, $2, 'pending')`,
      [appointmentId, copayAmount || 0]
    );

    res.status(201).json({ id: appointmentId, message: 'Appointment created successfully' });
  } catch (error) {
    console.error(error);
    res.status(500).json({ error: 'Server error' });
  }
});

// Reschedule appointment
router.post('/:id/reschedule', auth, async (req, res) => {
  const { appointmentDate, startTime, endTime } = req.body;

  try {
    // Get original appointment
    const original = await db.query(
      'SELECT * FROM appointments WHERE id = $1',
      [req.params.id]
    );

    if (original.rows.length === 0) {
      return res.status(404).json({ error: 'Appointment not found' });
    }

    // Validate new slot
    const existing = await db.query(
      `SELECT * FROM appointments 
       WHERE physician_id = $1 AND appointment_date = $2 
       AND status != 'cancelled' AND id != $3
       AND ((start_time <= $4 AND end_time > $4) OR (start_time < $5 AND end_time >= $5))`,
      [original.rows[0].physician_id, appointmentDate, req.params.id, startTime, endTime]
    );

    if (existing.rows.length > 0) {
      return res.status(400).json({ error: 'New time slot not available' });
    }

    // Update appointment
    await db.query(
      `UPDATE appointments 
       SET appointment_date = $1, start_time = $2, end_time = $3, updated_at = CURRENT_TIMESTAMP
       WHERE id = $4`,
      [appointmentDate, startTime, endTime, req.params.id]
    );

    res.json({ message: 'Appointment rescheduled successfully' });
  } catch (error) {
    console.error(error);
    res.status(500).json({ error: 'Server error' });
  }
});

// Cancel appointment
router.delete('/:id', auth, async (req, res) => {
  try {
    await db.query(
      "UPDATE appointments SET status = 'cancelled', updated_at = CURRENT_TIMESTAMP WHERE id = $1",
      [req.params.id]
    );

    res.json({ message: 'Appointment cancelled successfully' });
  } catch (error) {
    console.error(error);
    res.status(500).json({ error: 'Server error' });
  }
});

module.exports = router;
```

### Patient Routes (routes/patients.js)

```javascript
const express = require('express');
const auth = require('../middleware/auth');
const db = require('../config/db');

const router = express.Router();

// Get patient details
router.get('/:id', auth, async (req, res) => {
  try {
    const patient = await db.query(
      `SELECT p.*, u.email 
       FROM patients p
       JOIN users u ON p.user_id = u.id
       WHERE p.id = $1`,
      [req.params.id]
    );

    if (patient.rows.length === 0) {
      return res.status(404).json({ error: 'Patient not found' });
    }

    res.json(patient.rows[0]);
  } catch (error) {
    console.error(error);
    res.status(500).json({ error: 'Server error' });
  }
});

// Launch patient record (EHR integration)
router.get('/:id/ehr', auth, async (req, res) => {
  try {
    // This would integrate with your EHR system
    // For now, returning a mock URL
    res.json({
      ehrUrl: `https://ehr.yoursystem.com/patients/${req.params.id}`,
      token: 'temporary-access-token'
    });
  } catch (error) {
    console.error(error);
    res.status(500).json({ error: 'Server error' });
  }
});

module.exports = router;
```

### Financial Routes (routes/financials.js)

```javascript
const express = require('express');
const auth = require('../middleware/auth');
const db = require('../config/db');

const router = express.Router();

// Get appointment financials
router.get('/appointment/:id', auth, async (req, res) => {
  try {
    const financials = await db.query(
      'SELECT * FROM appointment_financials WHERE appointment_id = $1',
      [req.params.id]
    );

    if (financials.rows.length === 0) {
      return res.status(404).json({ error: 'Financial record not found' });
    }

    res.json(financials.rows[0]);
  } catch (error) {
    console.error(error);
    res.status(500).json({ error: 'Server error' });
  }
});

// Update payment
router.post('/appointment/:id/payment', auth, async (req, res) => {
  const { amountPaid } = req.body;

  try {
    const financial = await db.query(
      'SELECT * FROM appointment_financials WHERE appointment_id = $1',
      [req.params.id]
    );

    if (financial.rows.length === 0) {
      return res.status(404).json({ error: 'Financial record not found' });
    }

    const currentDue = parseFloat(financial.rows[0].amount_due);
    const newDue = currentDue - amountPaid;
    const paymentStatus = newDue <= 0 ? 'paid' : 'partial';

    await db.query(
      `UPDATE appointment_financials 
       SET amount_due = $1, payment_status = $2, payment_date = CURRENT_DATE
       WHERE appointment_id = $3`,
      [Math.max(0, newDue), paymentStatus, req.params.id]
    );

    res.json({ message: 'Payment processed successfully', remainingBalance: Math.max(0, newDue) });
  } catch (error) {
    console.error(error);
    res.status(500).json({ error: 'Server error' });
  }
});

module.exports = router;
```

---

## Frontend Implementation

### Package Configuration (package.json)

```json
{
  "name": "appointment-scheduler-frontend",
  "version": "0.1.0",
  "private": true,
  "scripts": {
    "dev": "next dev",
    "build": "next build",
    "start": "next start",
    "lint": "next lint"
  },
  "dependencies": {
    "next": "14.0.0",
    "react": "^18.2.0",
    "react-dom": "^18.2.0",
    "axios": "^1.5.1",
    "react-calendar": "^4.6.0",
    "react-hook-form": "^7.47.0",
    "react-toastify": "^9.1.3",
    "date-fns": "^2.30.0",
    "@headlessui/react": "^1.7.17",
    "@heroicons/react": "^2.0.18",
    "js-cookie": "^3.0.5"
  },
  "devDependencies": {
    "tailwindcss": "^3.3.5",
    "autoprefixer": "^10.4.16",
    "postcss": "^8.4.31",
    "@types/node": "^20.8.10",
    "typescript": "^5.2.2"
  }
}
```

### Layout Component (app/layout.js)

```javascript
import './globals.css'
import { Inter } from 'next/font/google'
import { ToastContainer } from 'react-toastify'
import 'react-toastify/dist/ReactToastify.css'
import { AuthProvider } from '@/contexts/AuthContext'

const inter = Inter({ subsets: ['latin'] })

export const metadata = {
  title: 'Medical Appointment Scheduler',
  description: 'Schedule and manage medical appointments',
}

export default function RootLayout({ children }) {
  return (
    <html lang="en">
      <body className={inter.className}>
        <AuthProvider>
          {children}
          <ToastContainer position="top-right" />
        </AuthProvider>
      </body>
    </html>
  )
}
```

### Global Styles (app/globals.css)

```css
@tailwind base;
@tailwind components;
@tailwind utilities;
```

### Authentication Context (contexts/AuthContext.js)

```javascript
'use client'

import { createContext, useContext, useState, useEffect } from 'react'
import axios from 'axios'
import Cookies from 'js-cookie'
import { useRouter } from 'next/navigation'

const AuthContext = createContext()

export function useAuth() {
  return useContext(AuthContext)
}

export function AuthProvider({ children }) {
  const [user, setUser] = useState(null)
  const [loading, setLoading] = useState(true)
  const router = useRouter()

  useEffect(() => {
    const token = Cookies.get('token')
    if (token) {
      axios.defaults.headers.common['Authorization'] = `Bearer ${token}`
      // Verify token and get user data
      fetchUser()
    }
    setLoading(false)
  }, [])

  const fetchUser = async () => {
    try {
      const response = await axios.get('http://localhost:5000/api/auth/me')
      setUser(response.data)
    } catch (error) {
      console.error('Error fetching user:', error)
      logout()
    }
  }

  const login = async (email, password) => {
    try {
      const response = await axios.post('http://localhost:5000/api/auth/login', {
        email,
        password
      })

      const { token, user } = response.data
      Cookies.set('token', token)
      axios.defaults.headers.common['Authorization'] = `Bearer ${token}`
      setUser(user)
      
      // Redirect based on role
      if (user.role === 'patient') {
        router.push('/patient/dashboard')
      } else if (user.role === 'physician') {
        router.push('/physician/dashboard')
      } else if (user.role === 'staff') {
        router.push('/staff/dashboard')
      }
    } catch (error) {
      throw error
    }
  }

  const logout = () => {
    Cookies.remove('token')
    delete axios.defaults.headers.common['Authorization']
    setUser(null)
    router.push('/login')
  }

  const value = {
    user,
    login,
    logout,
    loading
  }

  return <AuthContext.Provider value={value}>{children}</AuthContext.Provider>
}
```

### Home Page (app/page.js)

```javascript
'use client'

import Link from 'next/link'
import { useAuth } from '@/contexts/AuthContext'
import { useRouter } from 'next/navigation'
import { useEffect } from 'react'

export default function Home() {
  const { user } = useAuth()
  const router = useRouter()

  useEffect(() => {
    if (user) {
      if (user.role === 'patient') {
        router.push('/patient/dashboard')
      } else if (user.role === 'physician') {
        router.push('/physician/dashboard')
      } else if (user.role === 'staff') {
        router.push('/staff/dashboard')
      }
    }
  }, [user, router])

  return (
    <div className="min-h-screen bg-gradient-to-br from-blue-50 to-indigo-100 flex items-center justify-center">
      <div className="max-w-md w-full space-y-8 p-10 bg-white rounded-xl shadow-lg">
        <div className="text-center">
          <h1 className="text-4xl font-bold text-gray-900">Medical Appointment Scheduler</h1>
          <p className="mt-2 text-gray-600">Schedule and manage your appointments easily</p>
        </div>
        
        <div className="mt-8 space-y-4">
          <Link href="/login" className="w-full flex justify-center py-3 px-4 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">
            Login
          </Link>
          
          <Link href="/register" className="w-full flex justify-center py-3 px-4 border border-gray-300 rounded-md shadow-sm text-sm font-medium text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">
            Register
          </Link>
        </div>
      </div>
    </div>
  )
}
```

### Login Page (app/login/page.js)

```javascript
'use client'

import { useState } from 'react'
import { useForm } from 'react-hook-form'
import { useAuth } from '@/contexts/AuthContext'
import { toast } from 'react-toastify'
import Link from 'next/link'

export default function Login() {
  const { register, handleSubmit, formState: { errors } } = useForm()
  const [loading, setLoading] = useState(false)
  const { login } = useAuth()

  const onSubmit = async (data) => {
    setLoading(true)
    try {
      await login(data.email, data.password)
      toast.success('Login successful!')
    } catch (error) {
      toast.error(error.response?.data?.error || 'Login failed')
    } finally {
      setLoading(false)
    }
  }

  return (
    <div className="min-h-screen flex items-center justify-center bg-gray-50 py-12 px-4 sm:px-6 lg:px-8">
      <div className="max-w-md w-full space-y-8">
        <div>
          <h2 className="mt-6 text-center text-3xl font-extrabold text-gray-900">
            Sign in to your account
          </h2>
        </div>
        <form className="mt-8 space-y-6" onSubmit={handleSubmit(onSubmit)}>
          <input type="hidden" name="remember" value="true" />
          <div className="rounded-md shadow-sm -space-y-px">
            <div>
              <label htmlFor="email-address" className="sr-only">
                Email address
              </label>
              <input
                {...register('email', { required: 'Email is required' })}
                id="email-address"
                name="email"
                type="email"
                autoComplete="email"
                className="appearance-none rounded-none relative block w-full px-3 py-2 border border-gray-300 placeholder-gray-500 text-gray-900 rounded-t-md focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 focus:z-10 sm:text-sm"
                placeholder="Email address"
              />
              {errors.email && <p className="mt-1 text-sm text-red-600">{errors.email.message}</p>}
            </div>
            <div>
              <label htmlFor="password" className="sr-only">
                Password
              </label>
              <input
                {...register('password', { required: 'Password is required' })}
                id="password"
                name="password"
                type="password"
                autoComplete="current-password"
                className="appearance-none rounded-none relative block w-full px-3 py-2 border border-gray-300 placeholder-gray-500 text-gray-900 rounded-b-md focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 focus:z-10 sm:text-sm"
                placeholder="Password"
              />
              {errors.password && <p className="mt-1 text-sm text-red-600">{errors.password.message}</p>}
            </div>
          </div>

          <div>
            <button
              type="submit"
              disabled={loading}
              className="group relative w-full flex justify-center py-2 px-4 border border-transparent text-sm font-medium rounded-md text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 disabled:opacity-50"
            >
              {loading ? 'Signing in...' : 'Sign in'}
            </button>
          </div>

          <div className="text-center">
            <Link href="/register" className="font-medium text-indigo-600 hover:text-indigo-500">
              Don't have an account? Register
            </Link>
          </div>
        </form>
      </div>
    </div>
  )
}
```

### Patient Dashboard (app/patient/dashboard/page.js)

```javascript
'use client'

import { useState, useEffect } from 'react'
import { useAuth } from '@/contexts/AuthContext'
import axios from 'axios'
import { format } from 'date-fns'
import { CalendarIcon, ClockIcon, MapPinIcon } from '@heroicons/react/24/outline'
import Link from 'next/link'

export default function PatientDashboard() {
  const { user, logout } = useAuth()
  const [appointments, setAppointments] = useState([])
  const [loading, setLoading] = useState(true)

  useEffect(() => {
    fetchAppointments()
  }, [])

  const fetchAppointments = async () => {
    try {
      const response = await axios.get('http://localhost:5000/api/appointments')
      setAppointments(response.data)
    } catch (error) {
      console.error('Error fetching appointments:', error)
    } finally {
      setLoading(false)
    }
  }

  const cancelAppointment = async (id) => {
    if (window.confirm('Are you sure you want to cancel this appointment?')) {
      try {
        await axios.delete(`http://localhost:5000/api/appointments/${id}`)
        fetchAppointments()
      } catch (error) {
        console.error('Error canceling appointment:', error)
      }
    }
  }

  return (
    <div className="min-h-screen bg-gray-50">
      <nav className="bg-white shadow">
        <div className="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
          <div className="flex justify-between h-16">
            <div className="flex items-center">
              <h1 className="text-xl font-semibold">Patient Dashboard</h1>
            </div>
            <div className="flex items-center space-x-4">
              <span>Welcome, {user?.first_name}</span>
              <button onClick={logout} className="text-gray-500 hover:text-gray-700">
                Logout
              </button>
            </div>
          </div>
        </div>
      </nav>

      <main className="max-w-7xl mx-auto py-6 sm:px-6 lg:px-8">
        <div className="px-4 py-6 sm:px-0">
          <div className="flex justify-between items-center mb-6">
            <h2 className="text-2xl font-bold text-gray-900">Your Appointments</h2>
            <Link href="/patient/book-appointment" className="bg-indigo-600 text-white px-4 py-2 rounded-md hover:bg-indigo-700">
              Book New Appointment
            </Link>
          </div>

          {loading ? (
            <div className="text-center py-4">Loading...</div>
          ) : appointments.length === 0 ? (
            <div className="text-center py-8 bg-white rounded-lg shadow">
              <p className="text-gray-500">No appointments scheduled</p>
            </div>
          ) : (
            <div className="bg-white shadow overflow-hidden sm:rounded-md">
              <ul className="divide-y divide-gray-200">
                {appointments.map((appointment) => (
                  <li key={appointment.id}>
                    <div className="px-4 py-4 sm:px-6">
                      <div className="flex items-center justify-between">
                        <div className="flex items-center">
                          <div className="flex-shrink-0">
                            <div className="h-10 w-10 rounded-full bg-indigo-100 flex items-center justify-center">
                              <span className="text-indigo-600 font-medium">
                                {appointment.physician_first_name[0]}{appointment.physician_last_name[0]}
                              </span>
                            </div>
                          </div>
                          <div className="ml-4">
                            <div className="text-sm font-medium text-gray-900">
                              Dr. {appointment.physician_first_name} {appointment.physician_last_name}
                            </div>
                            <div className="flex items-center text-sm text-gray-500">
                              <CalendarIcon className="flex-shrink-0 mr-1.5 h-4 w-4" />
                              {format(new Date(appointment.appointment_date), 'PPP')}
                              <ClockIcon className="flex-shrink-0 ml-3 mr-1.5 h-4 w-4" />
                              {appointment.start_time} - {appointment.end_time}
                              <MapPinIcon className="flex-shrink-0 ml-3 mr-1.5 h-4 w-4" />
                              {appointment.location_name}
                            </div>
                            <div className="mt-1 text-sm text-gray-600">
                              Reason: {appointment.reason_for_visit}
                            </div>
                            {appointment.copay_amount > 0 && (
                              <div className="mt-1 text-sm text-gray-600">
                                Copay: ${appointment.copay_amount} ({appointment.payment_status})
                              </div>
                            )}
                          </div>
                        </div>
                        <div className="flex items-center space-x-2">
                          <span className={`px-2 py-1 text-xs rounded-full ${
                            appointment.status === 'scheduled' ? 'bg-green-100 text-green-800' :
                            appointment.status === 'cancelled' ? 'bg-red-100 text-red-800' :
                            'bg-gray-100 text-gray-800'
                          }`}>
                            {appointment.status}
                          </span>
                          {appointment.status === 'scheduled' && (
                            <>
                              <Link href={`/patient/reschedule/${appointment.id}`} className="text-indigo-600 hover:text-indigo-900 text-sm">
                                Reschedule
                              </Link>
                              <button onClick={() => cancelAppointment(appointment.id)} className="text-red-600 hover:text-red-900 text-sm">
                                Cancel
                              </button>
                            </>
                          )}
                        </div>
                      </div>
                    </div>
                  </li>
                ))}
              </ul>
            </div>
          )}
        </div>
      </main>
    </div>
  )
}
```

### Book Appointment Page (app/patient/book-appointment/page.js)

```javascript
'use client'

import { useState, useEffect } from 'react'
import { useRouter } from 'next/navigation'
import axios from 'axios'
import Calendar from 'react-calendar'
import 'react-calendar/dist/Calendar.css'
import { toast } from 'react-toastify'
import { format } from 'date-fns'

export default function BookAppointment() {
  const router = useRouter()
  const [step, setStep] = useState(1)
  const [physicians, setPhysicians] = useState([])
  const [selectedPhysician, setSelectedPhysician] = useState(null)
  const [selectedDate, setSelectedDate] = useState(new Date())
  const [availableSlots, setAvailableSlots] = useState([])
  const [selectedSlot, setSelectedSlot] = useState(null)
  const [reasonForVisit, setReasonForVisit] = useState('')
  const [loading, setLoading] = useState(false)

  useEffect(() => {
    fetchPhysicians()
  }, [])

  useEffect(() => {
    if (selectedPhysician && selectedDate) {
      fetchAvailableSlots()
    }
  }, [selectedPhysician, selectedDate])

  const fetchPhysicians = async () => {
    try {
      const response = await axios.get('http://localhost:5000/api/physicians')
      setPhysicians(response.data)
    } catch (error) {
      console.error('Error fetching physicians:', error)
    }
  }

  const fetchAvailableSlots = async () => {
    try {
      const response = await axios.get(`http://localhost:5000/api/physicians/${selectedPhysician.id}/available-slots`, {
        params: { date: format(selectedDate, 'yyyy-MM-dd') }
      })
      setAvailableSlots(response.data.slots)
    } catch (error) {
      console.error('Error fetching available slots:', error)
    }
  }

  const handleSubmit = async () => {
    setLoading(true)
    try {
      await axios.post('http://localhost:5000/api/appointments', {
        physicianId: selectedPhysician.id,
        locationId: 1, // Default location, should be dynamic
        appointmentDate: format(selectedDate, 'yyyy-MM-dd'),
        startTime: selectedSlot.start,
        endTime: selectedSlot.end,
        reasonForVisit,
        copayAmount: 25 // Default copay, should be dynamic based on insurance
      })
      toast.success('Appointment booked successfully!')
      router.push('/patient/dashboard')
    } catch (error) {
      toast.error('Failed to book appointment')
    } finally {
      setLoading(false)
    }
  }

  return (
    <div className="min-h-screen bg-gray-50 py-12 px-4 sm:px-6 lg:px-8">
      <div className="max-w-3xl mx-auto">
        <h1 className="text-3xl font-bold text-gray-900 mb-8">Book New Appointment</h1>

        {/* Progress Steps */}
        <div className="mb-8">
          <div className="flex items-center">
            <div className={`flex-1 ${step >= 1 ? 'bg-indigo-600' : 'bg-gray-300'} h-2 rounded`}></div>
            <div className={`flex-1 ${step >= 2 ? 'bg-indigo-600' : 'bg-gray-300'} h-2 rounded mx-2`}></div>
            <div className={`flex-1 ${step >= 3 ? 'bg-indigo-600' : 'bg-gray-300'} h-2 rounded`}></div>
          </div>
        </div>

        {step === 1 && (
          <div className="bg-white shadow rounded-lg p-6">
            <h2 className="text-xl font-semibold mb-4">Select a Physician</h2>
            <div className="grid grid-cols-1 gap-4">
              {physicians.map((physician) => (
                <div
                  key={physician.id}
                  className={`border rounded-lg p-4 cursor-pointer hover:border-indigo-500 ${
                    selectedPhysician?.id === physician.id ? 'border-indigo-500 bg-indigo-50' : 'border-gray-300'
                  }`}
                  onClick={() => setSelectedPhysician(physician)}
                >
                  <h3 className="font-medium">Dr. {physician.first_name} {physician.last_name}</h3>
                  <p className="text-sm text-gray-600">{physician.specialization}</p>
                </div>
              ))}
            </div>
            <div className="mt-6 flex justify-end">
              <button
                onClick={() => setStep(2)}
                disabled={!selectedPhysician}
                className="bg-indigo-600 text-white px-4 py-2 rounded-md hover:bg-indigo-700 disabled:opacity-50"
              >
                Next
              </button>
            </div>
          </div>
        )}

        {step === 2 && (
          <div className="bg-white shadow rounded-lg p-6">
            <h2 className="text-xl font-semibold mb-4">Select Date and Time</h2>
            <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
              <div>
                <h3 className="font-medium mb-2">Select Date</h3>
                <Calendar
                  onChange={setSelectedDate}
                  value={selectedDate}
                  minDate={new Date()}
                />
              </div>
              <div>
                <h3 className="font-medium mb-2">Available Time Slots</h3>
                <div className="grid grid-cols-2 gap-2 max-h-96 overflow-y-auto">
                  {availableSlots.length === 0 ? (
                    <p className="text-gray-500 col-span-2">No available slots for this date</p>
                  ) : (
                    availableSlots.map((slot, index) => (
                      <button
                        key={index}
                        onClick={() => setSelectedSlot(slot)}
                        className={`p-2 text-sm rounded ${
                          selectedSlot === slot
                            ? 'bg-indigo-600 text-white'
                            : 'bg-gray-100 hover:bg-gray-200'
                        }`}
                      >
                        {slot.start} - {slot.end}
                      </button>
                    ))
                  )}
                </div>
              </div>
            </div>
            <div className="mt-6 flex justify-between">
              <button
                onClick={() => setStep(1)}
                className="bg-gray-300 text-gray-700 px-4 py-2 rounded-md hover:bg-gray-400"
              >
                Back
              </button>
              <button
                onClick={() => setStep(3)}
                disabled={!selectedSlot}
                className="bg-indigo-600 text-white px-4 py-2 rounded-md hover:bg-indigo-700 disabled:opacity-50"
              >
                Next
              </button>
            </div>
          </div>
        )}

        {step === 3 && (
          <div className="bg-white shadow rounded-lg p-6">
            <h2 className="text-xl font-semibold mb-4">Appointment Details</h2>
            <div className="space-y-4">
              <div>
                <h3 className="font-medium">Summary</h3>
                <div className="mt-2 bg-gray-50 p-4 rounded">
                  <p><strong>Physician:</strong> Dr. {selectedPhysician.first_name} {selectedPhysician.last_name}</p>
                  <p><strong>Date:</strong> {format(selectedDate, 'PPP')}</p>
                  <p><strong>Time:</strong> {selectedSlot.start